name: Check & fix styling

on:
  push:
    branches:
      - '**' # run on all branches
  pull_request:
    branches:
      - '**'

jobs:
  style:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0 # important to push commits

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          coverage: none
          tools: composer

      - name: Fix style
        uses: docker://oskarstark/php-cs-fixer-ga
        with:
          args: --config=.php-cs-fixer.php --allow-risky=yes --verbose

      - name: Get branch name
        id: get_branch
        run: |
          # handle push and PR events safely
          if [ -n "$GITHUB_HEAD_REF" ]; then
            echo "branch=$GITHUB_HEAD_REF" >> $GITHUB_OUTPUT
          else
            echo "branch=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: fix styling via php-cs-fixer"
          branch: ${{ steps.get_branch.outputs.branch }}
          push: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
