# ------------------------------------------------------------------------
# Stage: base image
# Alpine 3.20 + PHP 8.4 (CLI)
# Verified for amd64 & arm64 architectures
# ------------------------------------------------------------------------
# Keep the original header comment as requested and preserve all comments.
# This variant is optimized with BuildKit cache mounts and separate cache targets
# so it never shares cache with the Debian-based Dockerfile.
# ------------------------------------------------------------------------

# Use BuildKit syntax features (for --mount=type=cache)
# syntax=docker/dockerfile:1.4
FROM php:8.4-cli-alpine AS alpine-base

# ------------------------------------------------------------------------
# Stage: System dependencies
# ------------------------------------------------------------------------
RUN apk update && apk upgrade && \
    apk del libressl libressl-dev || true && \
    apk add --no-cache \
    bash \
    curl \
    git \
    libpq \
    libzip \
    mariadb-connector-c \
    openssl \
    sqlite \
    supervisor \
    && mkdir -p /var/log/supervisor /app/logs

# ------------------------------------------------------------------------
# Stage: PHP extension build dependencies
# ------------------------------------------------------------------------
RUN apk add --no-cache --virtual .build-deps \
    autoconf \
    brotli-dev \
    c-ares-dev \
    g++ \
    libzip-dev \
    linux-headers \
    make \
    mariadb-connector-c-dev \
    openssl-dev \
    pkgconf \
    sqlite-dev

# Build PHP extensions with a cache for ext sources specific to Alpine.
# Cache target is /usr/src/php/ext-alpine (keeps it separate from Debian)
RUN --mount=type=cache,target=/usr/src/php/ext-alpine \
    docker-php-ext-install -j$(nproc) \
        sockets
        opcache \
        pdo \
        pdo_mysql \
        pdo_sqlite

# ------------------------------------------------------------------------
# Stage: Swoole extension via PECL
# ------------------------------------------------------------------------
ARG SWOOLE_VERSION=6.0.0
# Use a PECL cache mount targeted specifically for Alpine builds (/tmp/pecl-alpine)
# This prevents sharing PECL build artifacts with the Debian build.
RUN --mount=type=cache,target=/tmp/pecl-alpine \
    pecl install swoole-${SWOOLE_VERSION} && \
    docker-php-ext-enable swoole && \
    apk del .build-deps

# ------------------------------------------------------------------------
# Stage: Composer setup
# ------------------------------------------------------------------------
COPY --from=composer:2 /usr/bin/composer /usr/bin/composer

# ------------------------------------------------------------------------
# Stage: Application setup
# ------------------------------------------------------------------------
WORKDIR /app
COPY composer.json composer.lock ./

# Composer cache mount unique to Alpine: /root/.composer/cache-alpine
RUN --mount=type=cache,target=/root/.composer/cache-alpine \
    composer install --no-dev --optimize-autoloader --prefer-dist --no-interaction

# Copy all source files and supervisor config
COPY . .
COPY docker/supervisord.conf /etc/supervisor/conf.d/swoole.conf

# ------------------------------------------------------------------------
# Stage: Runtime configuration
# ------------------------------------------------------------------------
EXPOSE 9501 9310 9502

# Environment setup for production
ENV APP_ENV=production \
    APP_DEBUG=0 \
    PHP_OPCACHE_VALIDATE_TIMESTAMPS=0 \
    PHP_OPCACHE_MAX_ACCELERATED_FILES=20000 \
    PHP_OPCACHE_MEMORY_CONSUMPTION=256 \
    PHP_OPCACHE_INTERNED_STRINGS_BUFFER=16

# Default CMD: start supervisord -> swoole worker
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/swoole.conf"]
